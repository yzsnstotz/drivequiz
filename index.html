<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>足利驾校习题练习</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 10px;
      background-color: #e9f5ff;
      box-sizing: border-box;
    }

    h1 {
      text-align: center;
      color: #fff;
      background-color: #007BFF;
      padding: 15px 0;
      margin: 0;
      font-size: 24px;
    }

    h2 {
      text-align: center;
      color: #333;
      margin: 15px 0;
      font-size: 20px;
    }

    #container, #quiz-container, #result-container, #mistake-review-container, #current-mistakes-container, #console-logs-container {
      margin: 30px auto;
      max-width: 600px;
      border: 2px solid #ddd;
      border-radius: 10px;
      background-color: #fff;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      padding: 20px;
    }

    /* 调整初始页面套题按钮布局 */
    #sheet-selection {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      margin-bottom: 20px;
    }
    #sheet-selection button {
      flex: 0 1 auto;
      padding: 10px 15px;
      background: #007BFF;
      color: #fff;
      border: none;
      border-radius: 5px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s ease;
      white-space: nowrap;
    }
    #sheet-selection button:hover {
      transform: translateY(-3px);
      box-shadow: 0 4px 6px rgba(0,0,0,0.2);
    }

    #info {
      text-align: center;
      margin-top: 20px;
      color: #555;
      font-size: 14px;
      line-height: 1.6;
    }

    /* 下方三个操作按钮也分开一下 */
    #info button {
      margin: 10px 5px 0 5px;
      padding: 10px 15px;
      background: #4DAFFF;
      color: #fff;
      border: none;
      border-radius: 5px;
      font-size: 14px;
      cursor: pointer;
    }
    #info button:hover {
      transform: translateY(-3px);
      box-shadow: 0 4px 6px rgba(0,0,0,0.2);
    }

    #question {
      font-size: 18px;
      margin: 20px 0;
      padding: 15px;
      border-radius: 8px;
      background-color: #fdf8e4;
      text-align: center;
      min-height: 50px; 
      line-height: 1.4;
    }

    #image {
      margin-bottom: 20px;
      border: 2px solid #ccc;
      border-radius: 10px;
      background-color: #f0f8ff;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 50px; 
      padding: 10px;
    }
    #image img {
      max-width: 100%;
      max-height: 150px;
      object-fit: contain;
    }

    .options, .controls {
      display: flex;
      justify-content: space-around;
      margin-top: 15px;
    }
    .options button, .controls button {
      flex: 1;
      margin: 0 5px;
    }

    button {
      padding: 10px 15px;
      border: none;
      border-radius: 5px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease-in-out;
      text-align: center;
      white-space: nowrap;
    }
    button:hover {
      transform: translateY(-3px);
      box-shadow: 0 4px 6px rgba(0,0,0,0.2);
    }

    .correct {
      background: #007BFF;
      color: #fff;
    }
    .correct.highlight {
      background: #4DAFFF;
    }
    .wrong {
      background: #FF4D4D;
      color: #fff;
    }
    .wrong.highlight {
      background: #FF8C8C;
    }

    #answer-display {
      font-size: 18px;
      font-weight: bold;
      color: #FF4D4D;
      margin-top: 10px;
      text-align: center;
    }

    #remaining-questions {
      text-align: center; 
      margin-top: 20px;
      font-size: 16px;
      color: #333;
    }

    /* 列表页面(错题复习、当前错题查看)中题目信息的样式 */
    #mistake-questions > div, #current-mistakes-list > div {
      border-bottom: 1px solid #ccc;
      margin-bottom: 15px;
      padding-bottom: 15px;
      line-height: 1.4;
    }
    #mistake-questions img, #current-mistakes-list img {
      margin-top: 10px;
      border-radius: 5px;
      max-height:150px;
      object-fit:contain;
      max-width:100%;
    }

    #mistake-review-container button, #current-mistakes-container button, #console-logs-container button {
      margin-top: 10px;
    }

    #console-logs-content table {
      width:100%;
      border-collapse: collapse;
      margin-top:20px;
    }
    #console-logs-content table, #console-logs-content th, #console-logs-content td {
      border:1px solid #ccc;
      padding:5px;
      text-align:left;
      font-size:14px;
    }
    #console-logs-content th {
      background: #f9f9f9;
    }
  </style>
</head>
<body>
  <h1>足利驾校习题练习</h1>

  <div id="container">
    <h2>请选择套题</h2>
    <div id="sheet-selection">加载中...</div>
    <div id="info">
      <p>制作人微信：Leoyongzhe</p>
      <p>大家一起努力！</p>
      <p>欢迎大家反馈改进！</p>
      <button onclick="startMistakeReview()">错题复习</button>
      <button onclick="clearHistory()">清除历史做题记录</button>
      <button onclick="viewConsoleLogs()">查看控制台日志</button>
    </div>
  </div>

  <div id="quiz-container" style="display: none;">
    <h2 id="sheet-name">加载中...</h2>
    <div id="question">加载中...</div>
    <div id="image" style="display:none;"></div>
    <div class="options">
      <button id="btn-correct" class="correct" onclick="selectAnswer('⭕')">⭕ 正确</button>
      <button id="btn-wrong" class="wrong" onclick="selectAnswer('❌')">❌ 错误</button>
    </div>
    <div class="controls">
      <button onclick="previousQuestion()">上一题</button>
      <button onclick="nextQuestion()">下一题</button>
    </div>
    <div id="remaining-questions"></div>
    <div id="answer-display"></div>
    <div style="text-align: center; margin-top: 20px;">
      <button onclick="toggleAnswer()">显示/隐藏 正确答案</button>
      <button onclick="resetQuiz()">重新选题</button>
      <button onclick="submitQuiz()">交卷</button>
    </div>
  </div>

  <div id="result-container" style="display: none;">
    <h2>考试结束</h2>
    <p id="score"></p>
    <button onclick="resetQuiz()">再来一套</button>
    <button onclick="viewMistakes()">查看本次错题</button>
  </div>

  <div id="current-mistakes-container" style="display:none;">
    <h2>本次错题</h2>
    <div id="current-mistakes-list"></div>
    <button onclick="startMistakeReview()">复习错题</button>
    <button onclick="resetQuiz()">返回首页</button>
  </div>

  <div id="mistake-review-container" style="display:none;">
    <h2>错题复习</h2>
    <div id="mistake-questions"></div>
    <button onclick="resetQuiz()">返回首页</button>
  </div>

  <div id="console-logs-container" style="display:none;">
    <h2>控制台日志</h2>
    <div id="console-logs-content">加载中...</div>
    <button onclick="resetQuiz()">返回首页</button>
  </div>

  <script>
    const apiKey = "AIzaSyC_fcYBMTNaPt0u6qAvpn_73LlKwJbZ3Yw";
    const spreadsheetId = "1kiLBE8arF8OJyaAcO2AB_Jjd6_QNQQ1FbPp6Pn9CB64";
    let sheetNames = [];
    let questions = [];
    let currentQuestionIndex = 0;
    let userAnswers = [];
    let currentSheetName = "";
    let answerVisible = false;
    let mistakeQuestions = []; 
    let logs = [];

    getClientIPAndLogAccess();

    async function getClientIPAndLogAccess() {
      const visitTime = new Date().toLocaleString();
      const deviceInfo = navigator.userAgent;
      let ip = "Unknown IP";
      try {
        const res = await fetch('https://api.ipify.org?format=json');
        const data = await res.json();
        ip = data.ip || "Unknown IP";
      } catch(e) {}

      logs.push({
        type: 'access',
        time: visitTime,
        detail: {
          device: deviceInfo,
          ip: ip
        }
      });
    }

    function loadMistakesFromCache() {
      const mistakes = localStorage.getItem('mistakes');
      return mistakes ? JSON.parse(mistakes) : {};
    }

    function saveMistakesToCache(mistakesObj) {
      localStorage.setItem('mistakes', JSON.stringify(mistakesObj));
    }

    async function fetchSheetNames() {
      const selectionContainer = document.getElementById('sheet-selection');
      try {
        const url = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}?key=${apiKey}`;
        const response = await fetch(url);
        if(!response.ok) {
          selectionContainer.textContent = "加载套题失败，请检查网络或配置";
          return;
        }
        const data = await response.json();
        if(!data.sheets) {
          selectionContainer.textContent = "未能获取套题，请检查Google Sheet配置";
          return;
        }
        sheetNames = data.sheets.map(sheet => sheet.properties.title).filter(name => name !== "Console");
        displaySheetSelection();
      } catch (e) {
        console.error(e);
        selectionContainer.textContent = "加载套题失败，请检查配置或控制台日志";
      }
    }

    function displaySheetSelection() {
      const selectionContainer = document.getElementById('sheet-selection');
      selectionContainer.innerHTML = "";
      sheetNames.forEach(sheet => {
        const button = document.createElement('button');
        button.textContent = sheet;
        button.onclick = () => fetchQuestions(sheet);
        selectionContainer.appendChild(button);
      });
    }

    async function fetchQuestions(sheetName) {
      const sheetNameElem = document.getElementById('sheet-name');
      const questionElem = document.getElementById('question');
      sheetNameElem.textContent = "加载中...";
      questionElem.textContent = "加载中...";

      try {
        const url = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${sheetName}?key=${apiKey}`;
        const response = await fetch(url);
        if(!response.ok) {
          sheetNameElem.textContent = `加载套题[${sheetName}]失败`;
          questionElem.textContent = "";
          return;
        }
        const data = await response.json();
        if(!data.values || data.values.length < 1) {
          // 不需要slice(1)，因为现在数据从第一行开始都是题目行，无表头
          sheetNameElem.textContent = `套题[${sheetName}]数据为空`;
          questionElem.textContent = "";
          return;
        }
        currentSheetName = sheetName;
        questions = shuffle(processSheetData(data.values)); 
        // 不再使用 slice(1)，直接使用 data.values，因为没有表头行
        startQuiz();
      } catch(e) {
        console.error(e);
        sheetNameElem.textContent = `加载套题[${sheetName}]异常`;
        questionElem.textContent = "";
      }
    }

    function processSheetData(values) {
      // 直接从 values[0] 开始作为第一题
      return values.map((row, idx) => {
        let qText = row[1] ? row[1] : "";
        qText = qText.replace(/\u200B/g, '').trim();

        if (!qText) {
          const time = new Date().toLocaleString();
          const rowNumber = idx + 1; // rowNumber对应实际行号
          const colNumber = 2;
          logs.push({
            type: 'error',
            time: time,
            detail: {
              message: "无题目数据",
              sheet: currentSheetName,
              row: rowNumber,
              col: colNumber,
              questionData: row
            }
          });
          console.log(`无题目数据行: Sheet=${currentSheetName}, Row=${rowNumber}, Col=${colNumber}, 原始数据:`, row);
        }
        const qImage = row[2] ? row[2].trim() : "";
        return {
          question: qText || "无题目",
          image: qImage,
          answer: row[8] === "o" ? "⭕" : "❌"
        };
      });
    }

    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random()*(i+1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    function startQuiz() {
      currentQuestionIndex = 0;
      userAnswers = [];
      answerVisible = false;
      mistakeQuestions = [];

      document.getElementById('container').style.display = 'none';
      document.getElementById('quiz-container').style.display = 'block';
      document.getElementById('sheet-name').innerText = `当前套题：${currentSheetName}`;
      loadQuestion();
    }

    function loadQuestion() {
      const q = questions[currentQuestionIndex];
      const questionElem = document.getElementById('question');
      const imageContainer = document.getElementById('image');
      
      questionElem.textContent = "加载中...";
      imageContainer.style.display='none';
      imageContainer.innerHTML = '';

      setTimeout(() => {
        questionElem.innerText = q.question;
        resetButtonHighlight();
        updateRemainingQuestions();
      }, 200);

      if (q.image) {
        imageContainer.style.display='flex';
        imageContainer.innerText = "加载中...";
        const img = new Image();
        img.src = q.image;
        img.onload = () => {
          imageContainer.innerHTML = '';
          imageContainer.appendChild(img);
        };
        img.onerror = () => {
          console.log("图片加载失败：", q.image);
          imageContainer.innerHTML = '';
          imageContainer.style.display='none';
        }
      } else {
        imageContainer.style.display='none';
        imageContainer.innerHTML = '';
      }

      document.getElementById('answer-display').innerText = "";
    }

    function updateRemainingQuestions() {
      const remaining = questions.length - currentQuestionIndex - 1;
      document.getElementById('remaining-questions').innerText = `剩余题数：${remaining}`;
    }

    function selectAnswer(answer) {
      userAnswers[currentQuestionIndex] = answer;
      resetButtonHighlight();
      if (answer === '⭕') document.getElementById('btn-correct').classList.add('highlight');
      if (answer === '❌') document.getElementById('btn-wrong').classList.add('highlight');
    }

    function resetButtonHighlight() {
      document.getElementById('btn-correct').classList.remove('highlight');
      document.getElementById('btn-wrong').classList.remove('highlight');
    }

    function toggleAnswer() {
      const correctAnswer = questions[currentQuestionIndex].answer;
      if (answerVisible) {
        document.getElementById('answer-display').innerText = "";
      } else {
        document.getElementById('answer-display').innerText = `正确答案：${correctAnswer}`;
      }
      answerVisible = !answerVisible;
    }

    function nextQuestion() {
      if (currentQuestionIndex < questions.length - 1) {
        currentQuestionIndex++;
        loadQuestion();
      } else {
        alert('已到最后一题，请交卷。');
      }
    }

    function previousQuestion() {
      if (currentQuestionIndex > 0) {
        currentQuestionIndex--;
        loadQuestion();
      }
    }

    function allQuestionsAnswered() {
      return questions.every((q, i) => {
        const ans = userAnswers[i];
        return ans === '⭕' || ans === '❌';
      });
    }

    function submitQuiz() {
      if (!allQuestionsAnswered()) {
        const confirmSubmit = confirm("未完成所有题目，确定要交卷吗？");
        if (!confirmSubmit) {
          return;
        }
      }

      let incorrectCount = 0;
      let mistakesObj = loadMistakesFromCache();
      mistakeQuestions = [];

      questions.forEach((q, index) => {
        const userAnswer = userAnswers[index] || "";
        if (userAnswer !== "" && userAnswer !== q.answer) {
          incorrectCount++;
          mistakeQuestions.push({
            question: q.question,
            image: q.image,
            answer: q.answer,
            userAnswer: userAnswer
          });
          const key = q.question + '||' + q.answer + '||' + q.image;
          if (mistakesObj[key]) {
            mistakesObj[key].count += 1;
            mistakesObj[key].userAnswer = userAnswer;
          } else {
            mistakesObj[key] = {
              question: q.question,
              image: q.image,
              answer: q.answer,
              count: 1,
              userAnswer: userAnswer
            };
          }
        }
      });

      saveMistakesToCache(mistakesObj);

      document.getElementById('quiz-container').style.display = 'none';
      document.getElementById('result-container').style.display = 'block';
      document.getElementById('score').innerText = `错题数：${incorrectCount} / ${questions.length}`;
    }

    function resetQuiz() {
      document.getElementById('quiz-container').style.display = 'none';
      document.getElementById('result-container').style.display = 'none';
      document.getElementById('container').style.display = 'block';
      document.getElementById('mistake-review-container').style.display='none';
      document.getElementById('current-mistakes-container').style.display='none';
      document.getElementById('console-logs-container').style.display='none';
    }

    function viewMistakes() {
      document.getElementById('result-container').style.display = 'none';
      document.getElementById('current-mistakes-container').style.display = 'block';
      const mistakeContainer = document.getElementById('current-mistakes-list');
      mistakeContainer.innerHTML = '';

      if (mistakeQuestions.length === 0) {
        mistakeContainer.innerHTML = "<p>本次没有错题</p>";
        return;
      }

      mistakeQuestions.forEach((item, index) => {
        const questionDiv = document.createElement('div');
        questionDiv.style.paddingBottom = "10px";

        let imgHTML = '';
        if (item.image) {
          imgHTML = `<div><img src="${item.image}" alt="题目图片" style="max-width:100%;max-height:150px;object-fit:contain;margin-top:10px;"></div>`;
        }

        questionDiv.innerHTML =
        `<div><strong>题目 ${index + 1}：</strong>${item.question}</div>
         ${imgHTML}
         <div><strong>您的错误答案：</strong>${item.userAnswer}</div>
         <div><strong>正确答案：</strong>${item.answer}</div>`;
        mistakeContainer.appendChild(questionDiv);
      });
    }

    function startMistakeReview() {
      const mistakesObj = loadMistakesFromCache();
      const keys = Object.keys(mistakesObj);
      if (keys.length === 0) {
        alert("没有错题记录");
        return;
      }

      document.getElementById('container').style.display = 'none';
      document.getElementById('quiz-container').style.display = 'none';
      document.getElementById('result-container').style.display = 'none';
      document.getElementById('current-mistakes-container').style.display = 'none';
      document.getElementById('mistake-review-container').style.display = 'block';

      const mistakeContainer = document.getElementById('mistake-questions');
      mistakeContainer.innerHTML = '';

      keys.forEach((key, index) => {
        const item = mistakesObj[key];
        const uAnswer = item.userAnswer || "无记录";
        const cCount = (item.count !== undefined) ? item.count : "无记录";

        const questionDiv = document.createElement('div');

        let imgHTML = '';
        if (item.image) {
          imgHTML = `<div><img src="${item.image}" alt="题目图片" style="max-width:100%;max-height:150px;object-fit:contain;margin-top:10px;"></div>`;
        }

        questionDiv.innerHTML =
          `<div><strong>题目 ${index + 1}：</strong>${item.question}</div>
           ${imgHTML}
           <div><strong>您的最后错误答案：</strong>${uAnswer}</div>
           <div><strong>正确答案：</strong>${item.answer}</div>
           <div><strong>错误次数：</strong>${cCount}</div>`;
        mistakeContainer.appendChild(questionDiv);
      });
    }

    function clearHistory() {
      localStorage.removeItem('mistakes');
      alert("历史做题记录已清除");
    }

    async function viewConsoleLogs() {
      const password = prompt("请输入查看日志的密码：");
      if (password === "Aa123456") {
        try {
          await recordLogsToSheet();
        } catch(e) {
          console.error("写入日志到Google Sheet失败:", e);
        }
        showConsoleLogsFromSheet();
      } else {
        alert("密码错误！");
      }
    }

    async function recordLogsToSheet() {
      const values = logs.map(log => {
        if (log.type === 'access') {
          return [
            'access',
            log.time || '',
            log.detail.device || '',
            'N/A',
            'N/A',
            'N/A',
            log.detail.ip || '',
            'N/A'
          ];
        } else {
          return [
            'error',
            log.time || '',
            log.detail.message || '',
            log.detail.sheet || '',
            log.detail.row || '',
            log.detail.col || '',
            'N/A',
            JSON.stringify(log.detail.questionData || '')
          ];
        }
      });

      if(values.length === 0) {
        return;
      }

      const url = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/Console!A1:append?valueInputOption=RAW&key=${apiKey}`;
      const body = {
        values: values
      };

      const response = await fetch(url, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(body)
      });
    }

    async function showConsoleLogsFromSheet() {
      document.getElementById('container').style.display='none';
      document.getElementById('quiz-container').style.display='none';
      document.getElementById('result-container').style.display='none';
      document.getElementById('mistake-review-container').style.display='none';
      document.getElementById('current-mistakes-container').style.display='none';
      document.getElementById('console-logs-container').style.display='block';

      const consoleLogsContent = document.getElementById('console-logs-content');
      consoleLogsContent.textContent = "加载中...";

      try {
        const url = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/Console!A:Z?key=${apiKey}`;
        const response = await fetch(url);
        if(!response.ok) {
          consoleLogsContent.textContent = "加载日志失败";
          return;
        }
        const data = await response.json();
        if(!data.values || data.values.length <= 0) {
          consoleLogsContent.textContent = "暂无日志记录";
          return;
        }

        const table = document.createElement('table');
        const thead = document.createElement('thead');
        const headerRow = document.createElement('tr');
        const headers = ["Type","Time","Device/Message","Sheet","Row","Col","IP","QuestionData"];
        headers.forEach(h => {
          const th = document.createElement('th');
          th.textContent = h;
          headerRow.appendChild(th);
        });
        thead.appendChild(headerRow);
        table.appendChild(thead);

        const tbody = document.createElement('tbody');
        data.values.forEach((rowArr) => {
          const tr = document.createElement('tr');
          headers.forEach((h, i) => {
            const td = document.createElement('td');
            td.textContent = rowArr[i] || "";
            tr.appendChild(td);
          });
          tbody.appendChild(tr);
        });

        table.appendChild(tbody);
        consoleLogsContent.innerHTML = '';
        consoleLogsContent.appendChild(table);

      } catch(e) {
        console.error(e);
        consoleLogsContent.textContent = "加载日志出现异常";
      }
    }

    fetchSheetNames();
  </script>
</body>
</html>
