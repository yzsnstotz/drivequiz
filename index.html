<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>足利驾校习题练习</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 10px;
      background-color: #e9f5ff;
      box-sizing: border-box;
    }

    h1 {
      text-align: center;
      color: #fff;
      background-color: #007BFF;
      padding: 15px 0;
      margin: 0;
      font-size: 24px;
    }

    h2 {
      text-align: center;
      color: #333;
      margin: 15px 0;
      font-size: 20px;
    }

    #container, #quiz-container, #result-container, #mistake-review-container, #current-mistakes-container, #console-logs-container, #update-logs-container {
      margin: 30px auto;
      max-width: 600px;
      border: 2px solid #ddd;
      border-radius: 10px;
      background-color: #fff;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      padding: 20px;
    }

    #sheet-selection {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      margin-bottom: 20px;
    }
    #sheet-selection button {
      flex: 0 1 auto;
      padding: 10px 15px;
      background: #007BFF;
      color: #fff;
      border: none;
      border-radius: 5px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s ease;
      white-space: nowrap;
    }
    #sheet-selection button:hover {
      transform: translateY(-3px);
      box-shadow: 0 4px 6px rgba(0,0,0,0.2);
    }

    #info {
      text-align: center;
      margin-top: 20px;
      color: #555;
      font-size: 14px;
      line-height: 1.6;
    }

    #info button {
      margin: 10px 5px 0 5px;
      padding: 10px 15px;
      background: #4DAFFF;
      color: #fff;
      border: none;
      border-radius: 5px;
      font-size: 14px;
      cursor: pointer;
    }
    #info button:hover {
      transform: translateY(-3px);
      box-shadow: 0 4px 6px rgba(0,0,0,0.2);
    }

    /* 随机题序选项更醒目 */
    #random-option {
      text-align: center;
      margin-top: 20px;
      margin-bottom:20px;
      color: #333;
      font-size: 18px;
      font-weight: bold;
    }
    #random-option label {
      display: inline-block;
      cursor: pointer;
      padding:10px 20px;
      border:2px solid #007BFF;
      border-radius:5px;
      background:#fff;
    }
    #random-option input[type="checkbox"] {
      width:24px;
      height:24px;
      margin-right:10px;
      vertical-align:middle;
    }

    #question {
      font-size: 18px;
      margin: 20px 0;
      padding: 15px;
      border-radius: 8px;
      background-color: #fdf8e4;
      text-align: center;
      min-height: 50px; 
      line-height: 1.4;
    }

    #image {
      margin-bottom: 20px;
      border: 2px solid #ccc;
      border-radius: 10px;
      background-color: #f0f8ff;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 50px; 
      padding: 10px;
    }
    #image img {
      max-width: 100%;
      max-height: 150px;
      object-fit: contain;
    }

    .options, .controls {
      display: flex;
      justify-content: space-around;
      margin-top: 15px;
    }
    .options button, .controls button {
      flex: 1;
      margin: 0 5px;
    }

    button {
      padding: 10px 15px;
      border: none;
      border-radius: 5px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease-in-out;
      text-align: center;
      white-space: nowrap;
    }
    button:hover {
      transform: translateY(-3px);
      box-shadow: 0 4px 6px rgba(0,0,0,0.2);
    }

    .correct {
      background: #007BFF;
      color: #fff;
    }
    .correct.highlight {
      background: #4DAFFF;
    }
    .wrong {
      background: #FF4D4D;
      color: #fff;
    }
    .wrong.highlight {
      background: #FF8C8C;
    }

    #answer-display {
      font-size: 18px;
      font-weight: bold;
      color: #FF4D4D;
      margin-top: 10px;
      text-align: center;
    }

    #remaining-questions {
      text-align: center; 
      margin-top: 20px;
      font-size: 16px;
      color: #333;
    }

    #mistake-questions > div, #current-mistakes-list > div {
      border-bottom: 1px solid #ccc;
      margin-bottom: 15px;
      padding-bottom: 15px;
      line-height: 1.4;
    }
    #mistake-questions img, #current-mistakes-list img {
      margin-top: 10px;
      border-radius: 5px;
      max-height:150px;
      object-fit:contain;
      max-width:100%;
    }

    #mistake-review-container button, #current-mistakes-container button, #console-logs-container button, #update-logs-container button {
      margin-top: 10px;
    }

    #console-logs-content table {
      width:100%;
      border-collapse: collapse;
      margin-top:20px;
    }
    #console-logs-content table, #console-logs-content th, #console-logs-content td {
      border:1px solid #ccc;
      padding:5px;
      text-align:left;
      font-size:14px;
    }
    #console-logs-content th {
      background: #f9f9f9;
    }

    #update-logs-container {
      display:none;
    }
    #update-logs-list {
      font-size:14px;
      line-height:1.6;
    }
  </style>
</head>
<body>
  <h1>足利驾校习题练习</h1>

  <div id="container">
    <h2>请选择套题</h2>
    <div id="random-option">
      <label>
        <input type="checkbox" id="random-checkbox"> 随机题序
      </label>
    </div>

    <div id="sheet-selection">加载中...</div>
    <div id="info">
      <p>制作人微信：Leoyongzhe</p>
      <p>大家一起努力！</p>
      <p>欢迎大家反馈改进！</p>
      <button onclick="startMistakeReview()">错题复习</button>
      <button onclick="clearAllHistory()">清除历史</button>
      <button onclick="viewConsoleLogs()">查看控制台日志</button>
      <button onclick="showUpdateLogs()">更新日志</button>
      <button id="continue-exam-btn" style="display:none;" onclick="continueExam()">继续考试</button>
    </div>
  </div>

  <div id="quiz-container" style="display: none;">
    <h2 id="sheet-name">加载中...</h2>
    <div id="question">加载中...</div>
    <div id="image" style="display:none;"></div>
    <div class="options">
      <button id="btn-correct" class="correct" onclick="selectAnswer('⭕')">⭕ 正确</button>
      <button id="btn-wrong" class="wrong" onclick="selectAnswer('❌')">❌ 错误</button>
    </div>
    <div class="controls">
      <button onclick="previousQuestion()">上一题</button>
      <button onclick="nextQuestion()">下一题</button>
    </div>
    <div id="remaining-questions"></div>
    <div id="answer-display"></div>
    <div style="text-align: center; margin-top: 20px;">
      <button onclick="toggleAnswer()">显示/隐藏 正确答案</button>
      <button onclick="pauseExam()">暂停退出</button>
      <button onclick="submitQuiz()">交卷</button>
    </div>
  </div>

  <div id="result-container" style="display: none;">
    <h2>考试结束</h2>
    <p id="score"></p>
    <button onclick="resetQuiz()">再来一套</button>
    <button onclick="viewMistakes()">查看本次错题</button>
  </div>

  <div id="current-mistakes-container" style="display:none;">
    <h2>本次错题</h2>
    <div id="current-mistakes-list"></div>
    <button onclick="startMistakeReview()">复习错题</button>
    <button onclick="resetQuiz()">返回首页</button>
  </div>

  <div id="mistake-review-container" style="display:none;">
    <h2>错题复习</h2>
    <div id="mistake-questions"></div>
    <button onclick="resetQuiz()">返回首页</button>
  </div>

  <div id="console-logs-container" style="display:none;">
    <h2>控制台日志</h2>
    <div id="console-logs-content">加载中...</div>
    <button onclick="resetQuiz()">返回首页</button>
  </div>

  <div id="update-logs-container" style="display:none;">
    <h2>更新日志</h2>
    <div id="update-logs-list">
      <p>2024年12月18日更新：</p>
      <ul>
        <li>增加乱序/顺序题序选项</li>
        <li>增加选项和进度记录功能</li>
        <li>增加清除历史记录的功能</li>
        <li>增加意外退出（刷新/关闭页面）返回后继续考试的功能</li>
        <li>增加暂停考试后重新返回考试的功能</li>
        <li>增加错题查看的功能，修复图片展示问题</li>
        <li>修复”无题目“的问题</li>
        <li>增加错题复习功能，只要不清除历史即记录所有做错过的题目，并记录错误次数</li>
      </ul>
    </div>
    <button onclick="resetQuiz()">返回首页</button>
  </div>

  <script>
    const apiKey = "AIzaSyC_fcYBMTNaPt0u6qAvpn_73LlKwJbZ3Yw";
    const spreadsheetId = "1kiLBE8arF8OJyaAcO2AB_Jjd6_QNQQ1FbPp6Pn9CB64";
    let sheetNames = [];
    let questions = [];
    let currentQuestionIndex = 0;
    let userAnswers = [];
    let currentSheetName = "";
    let answerVisible = false;
    let mistakeQuestions = [];
    let logs = [];

    let randomOrder = loadRandomOrderSetting();
    const randomCheckbox = document.getElementById('random-checkbox');
    randomCheckbox.checked = randomOrder; 
    randomCheckbox.addEventListener('change', () => {
      randomOrder = randomCheckbox.checked;
      saveRandomOrderSetting(randomOrder);
    });

    const continueExamBtn = document.getElementById('continue-exam-btn');
    const savedExam = loadCurrentExam();
    if(savedExam) {
      continueExamBtn.style.display = 'inline-block';
    }

    getClientIPAndLogAccess();

    function loadRandomOrderSetting() {
      const setting = localStorage.getItem('randomOrder');
      return setting === 'true'; 
    }

    function saveRandomOrderSetting(value) {
      localStorage.setItem('randomOrder', value ? 'true' : 'false');
    }

    function loadCurrentExam() {
      const exam = localStorage.getItem('currentExam');
      return exam ? JSON.parse(exam) : null;
    }

    function saveCurrentExam() {
      const currentExam = {
        sheetName: currentSheetName,
        currentQuestionIndex,
        userAnswers,
        questions,
        randomOrder
      };
      localStorage.setItem('currentExam', JSON.stringify(currentExam));
    }

    function clearCurrentExam() {
      localStorage.removeItem('currentExam');
      continueExamBtn.style.display = 'none';
    }

    function continueExam() {
      const exam = loadCurrentExam();
      if(!exam) {
        alert("没有未完成的考试记录");
        return;
      }
      const {sheetName, currentQuestionIndex: idx, userAnswers:ua, questions:qs} = exam;
      const total = qs.length;
      const progress = idx+1;
      const confirmContinue = confirm(`检测到您上次考试未完成（套题名称：${sheetName}，进度：${progress}/${total}），是否继续？`);
      if(confirmContinue) {
        currentSheetName = sheetName;
        currentQuestionIndex = idx;
        userAnswers = ua;
        questions = qs;
        randomOrder = exam.randomOrder;
        startQuizFromState();
      } else {
        clearCurrentExam();
      }
    }

    function startQuizFromState() {
      document.getElementById('container').style.display = 'none';
      document.getElementById('quiz-container').style.display = 'block';
      document.getElementById('sheet-name').innerText = `当前套题：${currentSheetName}`;
      loadQuestion();
    }

    async function getClientIPAndLogAccess() {
      const visitTime = new Date().toLocaleString();
      const deviceInfo = navigator.userAgent;
      let ip = "Unknown IP";
      try {
        const res = await fetch('https://api.ipify.org?format=json');
        const data = await res.json();
        ip = data.ip || "Unknown IP";
      } catch(e) {}

      logs.push({
        type: 'access',
        time: visitTime,
        detail: {
          device: deviceInfo,
          ip: ip
        }
      });
    }

    function loadMistakesFromCache() {
      const mistakes = localStorage.getItem('mistakes');
      return mistakes ? JSON.parse(mistakes) : {};
    }

    function saveMistakesToCache(mistakesObj) {
      localStorage.setItem('mistakes', JSON.stringify(mistakesObj));
    }

    async function fetchSheetNames() {
      const selectionContainer = document.getElementById('sheet-selection');
      try {
        const url = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}?key=${apiKey}`;
        const response = await fetch(url);
        if(!response.ok) {
          selectionContainer.textContent = "加载套题失败，请检查网络或配置";
          return;
        }
        const data = await response.json();
        if(!data.sheets) {
          selectionContainer.textContent = "未能获取套题，请检查Google Sheet配置";
          return;
        }
        sheetNames = data.sheets.map(sheet => sheet.properties.title).filter(name => name !== "Console");
        displaySheetSelection();
      } catch (e) {
        console.error(e);
        selectionContainer.textContent = "加载套题失败，请检查配置或控制台日志";
      }
    }

    function displaySheetSelection() {
      const selectionContainer = document.getElementById('sheet-selection');
      selectionContainer.innerHTML = "";
      sheetNames.forEach(sheet => {
        const button = document.createElement('button');
        button.textContent = sheet;
        button.onclick = () => fetchQuestions(sheet);
        selectionContainer.appendChild(button);
      });
    }

    async function fetchQuestions(sheetName) {
      const sheetNameElem = document.getElementById('sheet-name');
      const questionElem = document.getElementById('question');
      sheetNameElem.textContent = "加载中...";
      questionElem.textContent = "加载中...";

      try {
        const url = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${sheetName}?key=${apiKey}`;
        const response = await fetch(url);
        if(!response.ok) {
          sheetNameElem.textContent = `加载套题[${sheetName}]失败`;
          questionElem.textContent = "";
          return;
        }
        const data = await response.json();
        if(!data.values || data.values.length < 1) {
          sheetNameElem.textContent = `套题[${sheetName}]数据为空`;
          questionElem.textContent = "";
          return;
        }
        currentSheetName = sheetName;
        questions = processSheetData(data.values);
        if(randomOrder) {
          questions = shuffle(questions);
        }
        startQuiz();
      } catch(e) {
        console.error(e);
        sheetNameElem.textContent = `加载套题[${sheetName}]异常`;
        questionElem.textContent = "";
      }
    }

    function processSheetData(values) {
      return values.map((row, idx) => {
        let qText = row[1] ? row[1] : "";
        qText = qText.replace(/\u200B/g, '').trim();

        if (!qText) {
          const time = new Date().toLocaleString();
          const rowNumber = idx + 1;
          const colNumber = 2;
          logs.push({
            type: 'error',
            time: time,
            detail: {
              message: "无题目数据",
              sheet: currentSheetName,
              row: rowNumber,
              col: colNumber,
              questionData: row
            }
          });
          console.log(`无题目数据行: Sheet=${currentSheetName}, Row=${rowNumber}, Col=${colNumber}, 原始数据:`, row);
        }
        const qImage = row[2] ? row[2].trim() : "";
        return {
          question: qText || "无题目",
          image: qImage,
          answer: row[8] === "o" ? "⭕" : "❌"
        };
      });
    }

    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random()*(i+1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    function startQuiz() {
      currentQuestionIndex = 0;
      userAnswers = [];
      answerVisible = false;
      mistakeQuestions = [];
      clearCurrentExam();
      document.getElementById('container').style.display = 'none';
      document.getElementById('quiz-container').style.display = 'block';
      document.getElementById('sheet-name').innerText = `当前套题：${currentSheetName}`;
      loadQuestion();
    }

    function loadQuestion() {
      const q = questions[currentQuestionIndex];
      const questionElem = document.getElementById('question');
      const imageContainer = document.getElementById('image');
      
      questionElem.textContent = "加载中...";
      imageContainer.style.display='none';
      imageContainer.innerHTML = '';

      setTimeout(() => {
        questionElem.innerText = q.question;
        resetButtonHighlight();
        updateRemainingQuestions();
      }, 200);

      if (q.image) {
        imageContainer.style.display='flex';
        imageContainer.innerText = "加载中...";
        const img = new Image();
        img.src = q.image;
        img.onload = () => {
          imageContainer.innerHTML = '';
          imageContainer.appendChild(img);
        };
        img.onerror = () => {
          console.log("图片加载失败：", q.image);
          imageContainer.innerHTML = '';
          imageContainer.style.display='none';
        }
      } else {
        imageContainer.style.display='none';
        imageContainer.innerHTML = '';
      }

      document.getElementById('answer-display').innerText = "";
      saveCurrentExam();
    }

    function updateRemainingQuestions() {
      const remaining = questions.length - currentQuestionIndex - 1;
      document.getElementById('remaining-questions').innerText = `剩余题数：${remaining}`;
    }

    function selectAnswer(answer) {
      userAnswers[currentQuestionIndex] = answer;
      resetButtonHighlight();
      if (answer === '⭕') document.getElementById('btn-correct').classList.add('highlight');
      if (answer === '❌') document.getElementById('btn-wrong').classList.add('highlight');
      saveCurrentExam();
    }

    function resetButtonHighlight() {
      document.getElementById('btn-correct').classList.remove('highlight');
      document.getElementById('btn-wrong').classList.remove('highlight');
    }

    function toggleAnswer() {
      const correctAnswer = questions[currentQuestionIndex].answer;
      if (answerVisible) {
        document.getElementById('answer-display').innerText = "";
      } else {
        document.getElementById('answer-display').innerText = `正确答案：${correctAnswer}`;
      }
      answerVisible = !answerVisible;
    }

    function nextQuestion() {
      if (currentQuestionIndex < questions.length - 1) {
        currentQuestionIndex++;
        loadQuestion();
      } else {
        alert('已到最后一题，请交卷。');
      }
    }

    function previousQuestion() {
      if (currentQuestionIndex > 0) {
        currentQuestionIndex--;
        loadQuestion();
      }
    }

    function allQuestionsAnswered() {
      return questions.every((q, i) => {
        const ans = userAnswers[i];
        return ans === '⭕' || ans === '❌';
      });
    }

    function submitQuiz() {
      if (!allQuestionsAnswered()) {
        const confirmSubmit = confirm("未完成所有题目，确定要交卷吗？");
        if (!confirmSubmit) {
          return;
        }
      }

      let incorrectCount = 0;
      let mistakesObj = loadMistakesFromCache();
      mistakeQuestions = [];

      questions.forEach((q, index) => {
        const userAnswer = userAnswers[index] || "";
        if (userAnswer !== "" && userAnswer !== q.answer) {
          incorrectCount++;
          const key = q.question + '||' + q.answer + '||' + q.image;
          if (mistakesObj[key]) {
            mistakesObj[key].count += 1;
            mistakesObj[key].userAnswer = userAnswer;
            if(!mistakesObj[key].sheetName) {
              mistakesObj[key].sheetName = currentSheetName;
            }
          } else {
            mistakesObj[key] = {
              question: q.question,
              image: q.image,
              answer: q.answer,
              count: 1,
              userAnswer: userAnswer,
              sheetName: currentSheetName
            };
          }

          mistakeQuestions.push({
            question: q.question,
            image: q.image,
            answer: q.answer,
            userAnswer: userAnswer,
            sheetName: currentSheetName
          });
        }
      });

      saveMistakesToCache(mistakesObj);
      clearCurrentExam(); 

      document.getElementById('quiz-container').style.display = 'none';
      document.getElementById('result-container').style.display = 'block';
      document.getElementById('score').innerText = `错题数：${incorrectCount} / ${questions.length}`;
    }

    function pauseExam() {
      alert("考试进度已保存，下次可继续当前考试！");
      document.getElementById('quiz-container').style.display = 'none';
      document.getElementById('container').style.display = 'block';
      if(loadCurrentExam()) {
        continueExamBtn.style.display = 'inline-block';
      }
    }

    function resetQuiz() {
      document.getElementById('quiz-container').style.display = 'none';
      document.getElementById('result-container').style.display = 'none';
      document.getElementById('container').style.display = 'block';
      document.getElementById('mistake-review-container').style.display='none';
      document.getElementById('current-mistakes-container').style.display='none';
      document.getElementById('console-logs-container').style.display='none';
      document.getElementById('update-logs-container').style.display='none';
      if(loadCurrentExam()) {
        continueExamBtn.style.display = 'inline-block';
      } else {
        continueExamBtn.style.display = 'none';
      }
    }

    function viewMistakes() {
      document.getElementById('result-container').style.display = 'none';
      document.getElementById('current-mistakes-container').style.display = 'block';
      const mistakeContainer = document.getElementById('current-mistakes-list');
      mistakeContainer.innerHTML = '';

      if (mistakeQuestions.length === 0) {
        mistakeContainer.innerHTML = "<p>本次没有错题</p>";
        return;
      }

      mistakeQuestions.forEach((item, index) => {
        const questionDiv = document.createElement('div');
        questionDiv.style.paddingBottom = "10px";

        let imgHTML = '';
        if (item.image) {
          imgHTML = `<div><img src="${item.image}" alt="题目图片" style="max-width:100%;max-height:150px;object-fit:contain;margin-top:10px;"></div>`;
        }

        questionDiv.innerHTML =
        `<div><strong>套题：</strong>${item.sheetName || "无记录"}</div>
         <div><strong>题目 ${index + 1}：</strong>${item.question}</div>
         ${imgHTML}
         <div><strong>您的错误答案：</strong>${item.userAnswer}</div>
         <div><strong>正确答案：</strong>${item.answer}</div>`;
        mistakeContainer.appendChild(questionDiv);
      });
    }

    function startMistakeReview() {
      const mistakesObj = loadMistakesFromCache();
      const keys = Object.keys(mistakesObj);
      if (keys.length === 0) {
        alert("没有错题记录");
        return;
      }

      document.getElementById('container').style.display = 'none';
      document.getElementById('quiz-container').style.display = 'none';
      document.getElementById('result-container').style.display = 'none';
      document.getElementById('current-mistakes-container').style.display = 'none';
      document.getElementById('console-logs-container').style.display = 'none';
      document.getElementById('update-logs-container').style.display = 'none';
      document.getElementById('mistake-review-container').style.display = 'block';

      const mistakeContainer = document.getElementById('mistake-questions');
      mistakeContainer.innerHTML = '';

      keys.forEach((key, index) => {
        const item = mistakesObj[key];
        const uAnswer = item.userAnswer || "无记录";
        const cCount = (item.count !== undefined) ? item.count : "无记录";
        const sheetNameDisplay = item.sheetName || "无记录";

        const questionDiv = document.createElement('div');

        let imgHTML = '';
        if (item.image) {
          imgHTML = `<div><img src="${item.image}" alt="题目图片" style="max-width:100%;max-height:150px;object-fit:contain;margin-top:10px;"></div>`;
        }

        questionDiv.innerHTML =
          `<div><strong>套题：</strong>${sheetNameDisplay}</div>
           <div><strong>题目 ${index + 1}：</strong>${item.question}</div>
           ${imgHTML}
           <div><strong>您的最后错误答案：</strong>${uAnswer}</div>
           <div><strong>正确答案：</strong>${item.answer}</div>
           <div><strong>错误次数：</strong>${cCount}</div>`;
        mistakeContainer.appendChild(questionDiv);
      });
    }

    function clearAllHistory() {
      const confirmClear = confirm("清除历史会导致错题集、未完成考试记录和相关设置全部清空，确定要清除吗？");
      if(confirmClear) {
        localStorage.clear();
        alert("历史记录已清除");
        resetQuiz();
      }
    }

    function showUpdateLogs() {
      document.getElementById('container').style.display='none';
      document.getElementById('quiz-container').style.display='none';
      document.getElementById('result-container').style.display='none';
      document.getElementById('mistake-review-container').style.display='none';
      document.getElementById('current-mistakes-container').style.display='none';
      document.getElementById('console-logs-container').style.display='none';
      document.getElementById('update-logs-container').style.display='block';
    }

    async function viewConsoleLogs() {
      const password = prompt("请输入查看日志的密码：");
      if (password === "Aa123456") {
        try {
          await recordLogsToSheet();
        } catch(e) {
          console.error("写入日志到Google Sheet失败:", e);
        }
        showConsoleLogsFromSheet();
      } else {
        alert("密码错误！");
      }
    }

    async function recordLogsToSheet() {
      const values = logs.map(log => {
        if (log.type === 'access') {
          return [
            'access',
            log.time || '',
            log.detail.device || '',
            'N/A',
            'N/A',
            'N/A',
            log.detail.ip || '',
            'N/A'
          ];
        } else {
          return [
            'error',
            log.time || '',
            log.detail.message || '',
            log.detail.sheet || '',
            log.detail.row || '',
            log.detail.col || '',
            'N/A',
            JSON.stringify(log.detail.questionData || '')
          ];
        }
      });

      if(values.length === 0) {
        return;
      }

      const url = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/Console!A1:append?valueInputOption=RAW&key=${apiKey}`;
      const body = {
        values: values
      };

      await fetch(url, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(body)
      });
    }

    async function showConsoleLogsFromSheet() {
      document.getElementById('container').style.display='none';
      document.getElementById('quiz-container').style.display='none';
      document.getElementById('result-container').style.display='none';
      document.getElementById('mistake-review-container').style.display='none';
      document.getElementById('current-mistakes-container').style.display='none';
      document.getElementById('update-logs-container').style.display='none';
      document.getElementById('console-logs-container').style.display='block';

      const consoleLogsContent = document.getElementById('console-logs-content');
      consoleLogsContent.textContent = "加载中...";

      try {
        const url = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/Console!A:Z?key=${apiKey}`;
        const response = await fetch(url);
        if(!response.ok) {
          consoleLogsContent.textContent = "加载日志失败";
          return;
        }
        const data = await response.json();
        if(!data.values || data.values.length <= 0) {
          consoleLogsContent.textContent = "暂无日志记录";
          return;
        }

        const table = document.createElement('table');
        const thead = document.createElement('thead');
        const headerRow = document.createElement('tr');
        const headers = ["Type","Time","Device/Message","Sheet","Row","Col","IP","QuestionData"];
        headers.forEach(h => {
          const th = document.createElement('th');
          th.textContent = h;
          headerRow.appendChild(th);
        });
        thead.appendChild(headerRow);
        table.appendChild(thead);

        const tbody = document.createElement('tbody');
        data.values.forEach((rowArr) => {
          const tr = document.createElement('tr');
          headers.forEach((h, i) => {
            const td = document.createElement('td');
            td.textContent = rowArr[i] || "";
            tr.appendChild(td);
          });
          tbody.appendChild(tr);
        });

        table.appendChild(tbody);
        consoleLogsContent.innerHTML = '';
        consoleLogsContent.appendChild(table);

      } catch(e) {
        console.error(e);
        consoleLogsContent.textContent = "加载日志出现异常";
      }
    }

    fetchSheetNames();
  </script>
</body>
</html>
